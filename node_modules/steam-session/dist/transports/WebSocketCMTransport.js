"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const crypto_1 = require("crypto");
const debug_1 = __importDefault(require("debug"));
const concurrency_1 = require("@doctormckay/stdlib/concurrency");
const data_structures_1 = require("@doctormckay/stdlib/data_structures");
const kvparser_1 = __importDefault(require("kvparser"));
const websocket13_1 = require("websocket13");
const zlib_1 = __importDefault(require("zlib"));
const EMsg_1 = __importDefault(require("../enums-steam/EMsg"));
const EResult_1 = __importDefault(require("../enums-steam/EResult"));
const load_1 = __importDefault(require("../protobuf-generated/load"));
const helpers_1 = require("../helpers");
const debug = (0, debug_1.default)('steam-session:WebSocketCMTransport');
const debugVerbose = debug.extend('verbose');
const PROTOCOL_VERSION = 65580;
const PROTO_MASK = 0x80000000;
let g_CmListRetrievalSemaphore = new concurrency_1.Semaphore();
let g_CmListCache = new data_structures_1.TTLCache(1000 * 60 * 5); // cache for 5 minutes
class WebSocketCMTransport {
    constructor(webClient, agent, localAddress) {
        this._connectTimeout = 1000;
        this._clientSessionId = 0;
        this._webClient = webClient;
        this._agent = agent;
        this._localAddress = localAddress;
        this._websocket = null;
        this._jobs = {};
    }
    async sendRequest(request) {
        for (let tryCount = 1; tryCount <= 3; tryCount++) {
            try {
                let targetName = `${request.apiInterface}.${request.apiMethod}#${request.apiVersion}`;
                return await this._sendMessage(EMsg_1.default.ServiceMethodCallFromClientNonAuthed, request.requestData, targetName);
            }
            catch (ex) {
                if (ex.eresult && [EResult_1.default.TryAnotherCM, EResult_1.default.ServiceUnavailable].includes(ex.eresult)) {
                    continue;
                }
                throw ex;
            }
        }
    }
    close() {
        if (this._websocket && this._websocket.state == websocket13_1.State.Connected) {
            this._websocket.disconnect();
        }
    }
    _connectToCM() {
        return new Promise(async (resolve, reject) => {
            try {
                if (this._websocket && this._websocket.state == websocket13_1.State.Connecting) {
                    // Just wait for the previous connection attempt to succeed
                    let connected, error;
                    connected = () => {
                        this._websocket.removeListener('error', error);
                        resolve();
                    };
                    error = (err) => {
                        this._websocket.removeListener('connected', connected);
                        reject(err);
                    };
                    this._websocket.once('connected', connected);
                    this._websocket.once('error', error);
                    return;
                }
                debug('_connectToCM()');
                let cmList = (await this._getCMList())
                    .filter(cm => cm.type == 'websockets' && cm.realm == 'steamglobal');
                // Choose a CM at random
                let randUpperBound = Math.min(20, cmList.length);
                let cm = cmList[Math.floor(Math.random() * randUpperBound)];
                debug(`Connecting to ${cm.endpoint}`);
                let resolved = false;
                this._websocket = new websocket13_1.WebSocket(`wss://${cm.endpoint}/cmsocket/`, {
                    connection: {
                        agent: this._agent,
                        localAddress: this._localAddress
                    }
                });
                this._websocket.setTimeout(this._connectTimeout);
                this._websocket.on('timeout', () => {
                    if (resolved) {
                        return;
                    }
                    debug(`Connecting to ${cm.endpoint} timed out after ${this._connectTimeout} ms`);
                    this._connectTimeout = Math.min(10000, this._connectTimeout * 2);
                    this._websocket.disconnect();
                    this._connectToCM().then(resolve).catch(reject);
                });
                this._websocket.on('connected', async () => {
                    this._websocket.setTimeout(0);
                    debug(`Connected to ${cm.endpoint}`);
                    let hello = { protocol_version: PROTOCOL_VERSION };
                    // @ts-ignore
                    await this._sendMessage(EMsg_1.default.ClientHello, load_1.default.CMsgClientHello.encode(hello).finish());
                    resolved = true;
                    resolve();
                });
                this._websocket.on('disconnected', (code, reason, initiatedByUs) => {
                    debug(`${initiatedByUs ? 'Disconnected' : 'Unexpectedly disconnected'} from ${cm.endpoint}: ${code} (${reason})`);
                    this._websocket = null;
                });
                this._websocket.on('error', (err) => {
                    debug(`Error ${resolved ? 'in' : 'connecting'} WebSocket with ${cm.endpoint}`);
                    if (!resolved) {
                        reject(err);
                    }
                });
                this._websocket.on('message', (type, msg) => {
                    if (type != websocket13_1.FrameType.Data.Binary) {
                        debug(`Received unexpected frame type from ${cm.endpoint}: ${type.toString(16)}`);
                        return;
                    }
                    this._handleWsMessage(msg);
                });
            }
            catch (ex) {
                reject(ex);
            }
        });
    }
    async _getCMList() {
        let release = await g_CmListRetrievalSemaphore.waitAsync();
        try {
            let cmList = g_CmListCache.get('cmlist');
            if (cmList) {
                debug('Using cached CM list');
                return cmList;
            }
            cmList = await this._fetchCMList();
            g_CmListCache.add('cmlist', cmList);
            return cmList;
        }
        finally {
            release();
        }
    }
    async _fetchCMList() {
        debug('Fetching CM list');
        let result = await this._webClient.request({
            method: 'GET',
            url: 'https://api.steampowered.com/ISteamDirectory/GetCMListForConnect/v0001/?cellid=0&format=vdf',
            headers: {
                'user-agent': 'Valve/Steam HTTP Client 1.0',
                'accept-charset': 'ISO-8859-1,utf-8,*;q=0.7',
                accept: 'text/html,*/*;q=0.9'
            }
        });
        if (result.statusCode != 200) {
            let err = new Error('Unable to fetch CM list');
            err.code = result.statusCode;
            throw err;
        }
        let parsedResult = kvparser_1.default.parse(result.textBody);
        if (!parsedResult.response || !parsedResult.response.serverlist) {
            throw new Error('Malformed CM list response');
        }
        if (parsedResult.response.success != 1) {
            throw new Error(parsedResult.response.message || 'GetCMListForConnect failure');
        }
        let serverList = parsedResult.response.serverlist;
        serverList.length = Object.keys(serverList).length;
        /** @var {CmServer[]} serverList */
        serverList = Array.prototype.slice.call(serverList);
        serverList.forEach((server) => {
            server.load = parseFloat(server.load);
            server.wtd_load = parseFloat(server.wtd_load);
        });
        serverList.sort((a, b) => a.wtd_load < b.wtd_load ? -1 : 1);
        debug(`Fetched ${serverList.length} CMs`);
        return Array.prototype.slice.call(serverList);
    }
    _handleWsMessage(msg) {
        let rawEmsg = msg.readUInt32LE(0);
        let hdrLength = msg.readUInt32LE(4);
        let hdrBuf = msg.slice(8, 8 + hdrLength);
        let msgBody = msg.slice(8 + hdrLength);
        if (!(rawEmsg & PROTO_MASK)) {
            if (rawEmsg == EMsg_1.default.ClientLogOnResponse) {
                // We would only expect this to happen if the CM is having a bad time.
                // Go ahead and just assume our connection is fubar
                this._disconnectIfApplicable();
                this._failAllPendingJobs((0, helpers_1.eresultError)(EResult_1.default.ServiceUnavailable));
                return;
            }
            else {
                throw new Error(`Received unexpected non-protobuf message ${rawEmsg}`);
            }
        }
        // @ts-ignore
        let decodedProtoHeader = load_1.default.CMsgProtoBufHeader.decode(hdrBuf);
        // @ts-ignore
        let protoHeader = load_1.default.CMsgProtoBufHeader.toObject(decodedProtoHeader, { longs: String });
        if (protoHeader.client_sessionid && protoHeader.client_sessionid != this._clientSessionId) {
            debugVerbose(`Got new client session id ${protoHeader.client_sessionid}`);
            this._clientSessionId = protoHeader.client_sessionid;
        }
        let eMsg = (rawEmsg & ~PROTO_MASK);
        if (eMsg != EMsg_1.default.Multi) {
            debugVerbose(`Receive: ${EMsg_1.default[eMsg] || eMsg} (${protoHeader.target_job_name})`);
        }
        if (protoHeader.jobid_target && this._jobs[protoHeader.jobid_target]) {
            let { resolve, timeout } = this._jobs[protoHeader.jobid_target];
            clearTimeout(timeout);
            delete this._jobs[protoHeader.jobid_target];
            let response = {
                result: protoHeader.eresult,
                errorMessage: protoHeader.error_message,
                responseData: msgBody
            };
            return resolve(response);
        }
        // this isn't a response message, so figure out what it is
        switch (eMsg) {
            case EMsg_1.default.ClientLogOnResponse:
                // The only time we expect to receive ClientLogOnResponse is when the CM is telling us to try another CM
                // @ts-ignore
                let decodedLogOnResponse = load_1.default.CMsgClientLogonResponse.decode(msgBody);
                // @ts-ignore
                let logOnResponse = load_1.default.CMsgClientLogonResponse.toObject(decodedLogOnResponse, { longs: String });
                debug(`Received ClientLogOnResponse with result: ${EResult_1.default[logOnResponse.eresult] || logOnResponse.eresult}`);
                this._disconnectIfApplicable();
                this._failAllPendingJobs((0, helpers_1.eresultError)(logOnResponse.eresult));
                break;
            case EMsg_1.default.Multi:
                // noinspection JSIgnoredPromiseFromCall
                this._processMultiMsg(msgBody);
                break;
            default:
                debug(`Received unexpected message: ${eMsg}`);
        }
    }
    async _processMultiMsg(body) {
        // @ts-ignore
        let decodedBody = load_1.default.CMsgMulti.decode(body);
        // @ts-ignore
        let multi = load_1.default.CMsgMulti.toObject(decodedBody, { longs: String });
        let payload = multi.message_body;
        if (multi.size_unzipped) {
            // We need to decompress it
            payload = await new Promise((resolve, reject) => {
                zlib_1.default.gunzip(payload, (err, unzipped) => {
                    if (err) {
                        return reject(err);
                    }
                    resolve(unzipped);
                });
            });
        }
        while (payload.length > 0) {
            let chunkSize = payload.readUInt32LE(0);
            this._handleWsMessage(payload.slice(4, 4 + chunkSize));
            payload = payload.slice(4 + chunkSize);
        }
    }
    _disconnectIfApplicable() {
        if (this._websocket.state == websocket13_1.State.Connected) {
            this._websocket.disconnect();
            this._websocket = null;
        }
    }
    _failAllPendingJobs(err) {
        for (let i in this._jobs) {
            let { reject, timeout } = this._jobs[i];
            clearTimeout(timeout);
            reject(err);
        }
    }
    async _sendMessage(eMsg, body, serviceMethodName) {
        if (!this._websocket || this._websocket.state != websocket13_1.State.Connected) {
            await this._connectToCM();
        }
        return await new Promise((resolve, reject) => {
            let protoHeader = {
                steamid: '0',
                client_sessionid: eMsg != EMsg_1.default.ServiceMethodCallFromClientNonAuthed ? this._clientSessionId : 0,
            };
            if (eMsg == EMsg_1.default.ServiceMethodCallFromClientNonAuthed) {
                let jobIdBuffer = (0, crypto_1.randomBytes)(8);
                jobIdBuffer[0] &= 0x7f; // make sure it's always a positive value
                let jobId = jobIdBuffer.readBigInt64BE(0).toString(10);
                protoHeader.jobid_source = jobId;
                protoHeader.target_job_name = serviceMethodName;
                protoHeader.realm = 1;
                let timeout = setTimeout(() => {
                    reject(new Error(`Request ${serviceMethodName} timed out`));
                }, 5000);
                this._jobs[jobId] = { resolve, reject, timeout };
            }
            else {
                // There's no response, so just resolve right now
                resolve(undefined);
            }
            // @ts-ignore
            let encodedProtoHeader = load_1.default.CMsgProtoBufHeader.encode(protoHeader).finish();
            let header = Buffer.alloc(8);
            header.writeUInt32LE((eMsg | PROTO_MASK) >>> 0, 0);
            header.writeUInt32LE(encodedProtoHeader.length, 4);
            debugVerbose(`Send: ${EMsg_1.default[eMsg] || eMsg} (${serviceMethodName})`);
            this._websocket.send(Buffer.concat([
                header,
                encodedProtoHeader,
                body
            ]));
        });
    }
}
exports.default = WebSocketCMTransport;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2ViU29ja2V0Q01UcmFuc3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdHJhbnNwb3J0cy9XZWJTb2NrZXRDTVRyYW5zcG9ydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLG1DQUFtQztBQUNuQyxrREFBZ0M7QUFFaEMsaUVBQTBEO0FBQzFELHlFQUE2RDtBQUU3RCx3REFBMkI7QUFDM0IsNkNBQWtGO0FBQ2xGLGdEQUF3QjtBQUV4QiwrREFBdUM7QUFDdkMscUVBQTZDO0FBRTdDLHNFQUFnRDtBQUdoRCx3Q0FBd0M7QUFFeEMsTUFBTSxLQUFLLEdBQUcsSUFBQSxlQUFXLEVBQUMsb0NBQW9DLENBQUMsQ0FBQztBQUNoRSxNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRTdDLE1BQU0sZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO0FBQy9CLE1BQU0sVUFBVSxHQUFHLFVBQVUsQ0FBQztBQUU5QixJQUFJLDBCQUEwQixHQUFHLElBQUksdUJBQVMsRUFBRSxDQUFDO0FBQ2pELElBQUksYUFBYSxHQUFHLElBQUksMEJBQVEsQ0FBYSxJQUFJLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsc0JBQXNCO0FBWW5GLE1BQXFCLG9CQUFvQjtJQVN4QyxZQUFZLFNBQXFCLEVBQUUsS0FBWSxFQUFFLFlBQXFCO1FBUnRFLG9CQUFlLEdBQUcsSUFBSSxDQUFDO1FBTXZCLHFCQUFnQixHQUFHLENBQUMsQ0FBQztRQUdwQixJQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztRQUM1QixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFJLENBQUMsYUFBYSxHQUFHLFlBQVksQ0FBQztRQUNsQyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztJQUNqQixDQUFDO0lBRUQs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